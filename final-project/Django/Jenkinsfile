pipeline {
  parameters {
    string(name: 'AWS_REGION', defaultValue: 'us-west-2', description: 'AWS region')
    string(name: 'ECR_REGISTRY', defaultValue: '804219314385.dkr.ecr.us-west-2.amazonaws.com', description: 'ECR registry')
    string(name: 'IMAGE_NAME', defaultValue: 'lesson-8-9-ecr', description: 'ECR repository name')
    string(name: 'GITOPS_REPO', defaultValue: 'https://github.com/Vadimka180880/my-microservice-project.git', description: 'GitOps repo URL')
    string(name: 'GITOPS_BRANCH', defaultValue: 'lesson-8-9', description: 'GitOps branch')
    string(name: 'VALUES_PATH', defaultValue: 'lesson-7/charts/django-app/values.yaml', description: 'Path to Helm values')
    string(name: 'DOCKER_CONTEXT', defaultValue: 'docker-django', description: 'Docker build context')
    string(name: 'DOCKERFILE', defaultValue: 'docker-django/Dockerfile', description: 'Dockerfile path')
    string(name: 'GIT_USER_NAME', defaultValue: 'ci', description: 'Git user name for commits')
    string(name: 'GIT_USER_EMAIL', defaultValue: 'ci@example.com', description: 'Git user email for commits')
  }
  agent {
    kubernetes {
      yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command:
    - /busybox/sh
    - -c
    - sleep 365d
    tty: true
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
  - name: awscli
    image: amazon/aws-cli:2.15.47
    command:
    - cat
    tty: true
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
  - name: git
    image: alpine/git:2.43.0
    command:
    - cat
    tty: true
  volumes: 
  - name: docker-config
    emptyDir: {}
'''
    }
  } 
    
  environment {
    AWS_REGION = "${params.AWS_REGION}"
    ECR_REGISTRY = "${params.ECR_REGISTRY}"
    IMAGE_NAME = "${params.IMAGE_NAME}"
    GITOPS_REPO = "${params.GITOPS_REPO}"
    VALUES_PATH = "${params.VALUES_PATH}"
    DOCKER_CONTEXT = "${params.DOCKER_CONTEXT}"
    DOCKERFILE = "${params.DOCKERFILE}"
    GIT_USER_NAME = "${params.GIT_USER_NAME}"
    GIT_USER_EMAIL = "${params.GIT_USER_EMAIL}"
    GIT_CRED_ID = "git-cred"
    AWS_CRED_ID = "aws-cred"
    GITOPS_BRANCH = "${params.GITOPS_BRANCH}"
  }

  stages {
    stage('Build and Push') {
      steps {
        withCredentials([
          usernamePassword(credentialsId: "${AWS_CRED_ID}", usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          container('awscli') {
            sh '''
              TOKEN=$(aws ecr get-login-password --region $AWS_REGION)
              mkdir -p /kaniko/.docker
              cat > /kaniko/.docker/config.json <<EOF
{
  "auths": {
    "${ECR_REGISTRY}": {
      "auth": "$(printf "AWS:%s" "$TOKEN" | base64 | tr -d '\n')"
    }
  }
}
EOF
            '''
          }
          container('kaniko') {
            sh '/kaniko/executor --context $WORKSPACE/$DOCKER_CONTEXT --dockerfile $WORKSPACE/$DOCKERFILE --destination $ECR_REGISTRY/$IMAGE_NAME:$BUILD_NUMBER'
          }
        }
      }
    }

    stage('Update Helm values') {
      steps {
        withCredentials([
          usernamePassword(credentialsId: "${GIT_CRED_ID}", usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')
        ]) {
          container('git') {
            sh '''
              git config --global user.email "$GIT_USER_EMAIL"
              git config --global user.name "$GIT_USER_NAME"
              git clone --branch $GITOPS_BRANCH https://$GIT_USERNAME:$GIT_PASSWORD@${GITOPS_REPO#https://} gitops
              cd gitops
              sed -i "s/tag: .*/tag: $BUILD_NUMBER/" $VALUES_PATH
              git add $VALUES_PATH
              git commit -m "Update image tag to $BUILD_NUMBER" || true
              git push origin $GITOPS_BRANCH
            '''
          }
        }
      }
    }
  }
}
