pipeline {
  agent {
    kubernetes {
      yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
  - name: awscli
    image: amazon/aws-cli:2.15.47
    command:
    - cat
    tty: true
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
  - name: git
    image: alpine/git:2.43.0
    command:
    - cat
    tty: true
  volumes: 
  - name: docker-config
    emptyDir: {}
'''
    }
  } 
    
  environment {
    AWS_REGION = "us-west-2"
    ECR_REGISTRY = "804219314385.dkr.ecr.us-west-2.amazonaws.com"
    IMAGE_NAME = "lesson-8-9-ecr"
    GITOPS_REPO = "https://github.com/Vadimka180880/my-microservice-project.git"
    VALUES_PATH = "lesson-7/charts/django-app/values.yaml"
    DOCKER_CONTEXT = "docker-django"
    DOCKERFILE = "docker-django/Dockerfile"
    GIT_CRED_ID = "git-cred"
    AWS_CRED_ID = "aws-cred"
  }

  stages {
    stage('Build and Push') {
      steps {
        withCredentials([
          usernamePassword(credentialsId: "${AWS_CRED_ID}", usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY')
        ]) {
          container('awscli') {
            sh '''
              TOKEN=$(aws ecr get-login-password --region $AWS_REGION)
              mkdir -p /kaniko/.docker
              cat > /kaniko/.docker/config.json <<EOF
{
  "auths": {
    "${ECR_REGISTRY}": {
      "auth": "$(printf "AWS:%s" "$TOKEN" | base64 | tr -d '\n')"
    }
  }
}
EOF
            '''
          }
          container('kaniko') {
            sh '/kaniko/executor --context $WORKSPACE/$DOCKER_CONTEXT --dockerfile $WORKSPACE/$DOCKERFILE --destination $ECR_REGISTRY/$IMAGE_NAME:$BUILD_NUMBER'
          }
        }
      }
    }

    stage('Update Helm values') {
      steps {
        withCredentials([
          usernamePassword(credentialsId: "${GIT_CRED_ID}", usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD')
        ]) {
          container('git') {
            sh '''
              git config --global user.email "ci@example.com"
              git config --global user.name "ci"
              git clone https://$GIT_USERNAME:$GIT_PASSWORD@github.com/Vadimka180880/my-microservice-project.git gitops
              cd gitops
              sed -i "s/tag: .*/tag: $BUILD_NUMBER/" $VALUES_PATH
              git add $VALUES_PATH
              git commit -m "Update image tag to $BUILD_NUMBER" || true
              git push origin main
            '''
          }
        }
      }
    }
  }
}
